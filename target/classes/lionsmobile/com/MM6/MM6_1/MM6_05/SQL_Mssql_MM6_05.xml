<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="lionsmobile.com.MM6.MM6_1.MM6_05">

	<typeAlias alias="MM6_05VO_MEMBER" type="lionsmobile.com.MM6.MM6_1.MM6_05.MM6_05VO_MEMBER"/>
	<typeAlias alias="MM6_05VO_CLUB_INFO" type="lionsmobile.com.MM6.MM6_1.MM6_05.MM6_05VO_CLUB_INFO"/>
	<typeAlias alias="MM6_05VO_PARAM" type="lionsmobile.com.MM6.MM6_1.MM6_05.MM6_05VO_PARAM"/>
 	
 	
 	<select id="lionsmobile.com.MM6.MM6_1.MM6_05.selectClubChairManList" resultClass="MM6_05VO_MEMBER" parameterClass="MM6_05VO_PARAM">
		<![CDATA[
DECLARE @fromDate NVARCHAR(8)
DECLARE @toDate NVARCHAR(8)
DECLARE @districtCode NVARCHAR(10)
SET @fromDate = #fromDate#;
SET @toDate = #toDate#;
SET @districtCode = #districtCode#;

WITH MAX_HIST_IDN_NO_FOR_CLUB_HIST AS ( /* 회기별 클럽 소속 회원 번호 */
	SELECT
		 MAX(IDN_NO) as IDN_NO
		,MEMBER_NO
	FROM dbo.LIONS_MEMBER_CLUB_HIST
	WHERE 	
	(
		(START_DATE >= @fromDate AND START_DATE <= @toDate)
	 OR (END_DATE   >= @fromDate AND END_DATE <= @toDate)
	 OR (START_DATE <= @fromDate AND END_DATE >= @fromDate) 
	 OR (START_DATE <= @toDate   AND END_DATE >= @toDate)
	)
	GROUP BY MEMBER_NO
)
,
ORG_TREE AS ( /* 조직트리 */
	SELECT
		 A.ORGAN_CODE
		,A.UPPER_ORGAN_CODE
	FROM dbo.LIONS_ORGAN_CODE_HISTORY A
	INNER JOIN (
		SELECT
			 MAX(B.IDN_NO) as IDN_NO
			,B.ORGAN_CODE
		FROM ( 
			SELECT
				 A.ORGAN_CODE
				,A.IDN_NO
				,MAX(A.CHANGE_DATE) OVER(PARTITION BY A.ORGAN_CODE) as CHANGE_DATE
			FROM dbo.LIONS_ORGAN_CODE_HISTORY A
			WHERE A.CHANGE_DATE BETWEEN @fromDate AND @toDate
		) B
		GROUP BY B.ORGAN_CODE,B.CHANGE_DATE
	) C ON C.IDN_NO = A.IDN_NO
	INNER JOIN dbo.LIONS_ORGAN_CODE D
	ON D.ORGAN_CODE = A.ORGAN_CODE
	AND (
				D.ORGAN_ABOLISH_DATE IS NULL 
			OR	D.ORGAN_ABOLISH_DATE = '' 
			OR	D.ORGAN_ABOLISH_DATE >= @fromDate
	)
	WHERE A.UPPER_ORGAN_CODE = @districtCode
)
, MEMBER_CLUB_INFO AS ( /* 회원별 클럽코드 */
	SELECT
	 A.MEMBER_NO
	,A.ORGAN_CODE
	FROM dbo.LIONS_MEMBER_CLUB_HIST A
	INNER JOIN MAX_HIST_IDN_NO_FOR_CLUB_HIST B ON B.IDN_NO = A.IDN_NO
	WHERE 
	(
		(START_DATE >= @fromDate AND START_DATE <= @toDate)
	 OR (END_DATE   >= @fromDate AND END_DATE <= @toDate)
	 OR (START_DATE <= @fromDate AND END_DATE >= @fromDate) 
	 OR (START_DATE <= @toDate   AND END_DATE >= @toDate)
	)
)
, CLUB_TITLE AS( /* 클럽직책 */
	SELECT
	 A.MEMBER_NO
	,A.APP_DESC_CODE
	,A.APP_SECTOR_CODE
	,C.CODE_NAME AS APP_DESC_CODE_NAME
	,C.ORD
	,C.CODE2
	FROM dbo.LIONS_APPOINTMENT A
	INNER JOIN (
		SELECT
		 MAX(IDN_NO) as IDN_NO
		FROM dbo.LIONS_APPOINTMENT
		WHERE 
			APP_KIND_CODE = '1000'
		AND 
		(
			(START_DATE >= @fromDate AND START_DATE <= @toDate)
		 OR (END_DATE   >= @fromDate AND END_DATE <= @toDate)
		 OR (START_DATE <= @fromDate AND END_DATE >= @fromDate) 
		 OR (START_DATE <= @toDate   AND END_DATE >= @toDate)
		)
		AND APP_DESC_CODE IN (
			SELECT  CODE FROM LIONS_CODE WHERE GROUP_CODE = (
				SELECT
					CODE1
				FROM LIONS_CODE WHERE GROUP_CODE = '2700' AND CODE = '1000'		
			) AND CODE1='*' 
		)
		GROUP BY MEMBER_NO
	) B
	ON B.IDN_NO = A.IDN_NO
	INNER JOIN dbo.LIONS_CODE C
	ON C.GROUP_CODE = ( SELECT X.CODE1 FROM dbo.LIONS_CODE X WHERE X.CODE= '1000' AND X.GROUP_CODE='2700')
	AND C.CODE = A.APP_DESC_CODE
	AND C.CODE2 IN ('1')
)

SELECT
	 B.MEMBER_NO	as memberNo
	,A.NAME			as name
	,D.APP_DESC_CODE_NAME	as lvlName
	,A.COMPANY_NAME	as companyName
	,E.CODE_NAME	as companyTitle
	,A.MOBILE	as mobile
	,'/lionsclubs/upload/' + SUBSTRING(F.FILE_MASK,1,6) + '/' + SUBSTRING(F.FILE_MASK,7,2) + '/' + F.FILE_MASK + '.thumb' as memPicFile
	,ISNULL(D.ORD,'ZZZZZZZZZZZZ') as ord
	/* ,C.KO_ABBR AS sectorClub */
	,RIGHT(C.ORGAN_CODE,3) + ' ' + C.KO_ABBR as sectorClub
FROM MEMBER_CLUB_INFO B
INNER JOIN CLUB_TITLE D
ON D.MEMBER_NO = B.MEMBER_NO
INNER JOIN LIONS_ORGAN_CODE C
ON C.ORGAN_CODE = D.APP_SECTOR_CODE
INNER JOIN LIONS_MEMBER_INFO A
ON A.MEMBER_NO = B.MEMBER_NO
INNER JOIN ORG_TREE X
ON X.ORGAN_CODE = D.APP_SECTOR_CODE
LEFT OUTER JOIN dbo.LIONS_CODE E
ON E.GROUP_CODE = '2500'
AND E.CODE = A.COMPANY_TITLE
LEFT OUTER JOIN dbo.J_ATTACHFILE F
ON F.FILE_ID = A.MEMBER_PICTURE_FILE
ORDER BY D.APP_SECTOR_CODE
		]]>
 	</select>
</sqlMap>
